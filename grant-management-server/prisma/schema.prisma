// Generator and Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  SUPERVISOR
  STUDENT
  SPONSOR
  DONOR
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum ApplicationStatus {
  DRAFT
  PENDING
  UNDER_REVIEW
  UN_COMPLETE
  APPROVED
  REJECTED
}

enum StudentType {
  NEW
  CURRENT
}

enum TicketStatus {
  OPEN
  CLOSED
}

enum NotificationType {
  APPLICATION
  TICKET
  MESSAGE
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  TASK_ASSIGNED
  TASK_COMPLETED
  PAYMENT_DUE
  PAYMENT_COMPLETED
}

enum StudySource {
  SELF_FUNDED
  SCHOLARSHIP
}

enum ResidenceType {
  FAMILY
  PRIVATE_HOUSING
  DORMITORY
}

enum ParentStatus {
  ALIVE
  DECEASED
  MISSING
}

enum SupportType {
  FULL_SCHOLARSHIP
  PARTIAL_SCHOLARSHIP
  TUITION_ONLY
  PERSONAL_EXPENSES
}

enum GpaType {
  GPA_4
  PERCENTAGE
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}

enum GrantType {
  SPONSOR
  OTHER
}

enum FileType {
  ID
  ACADEMIC
  MEDICAL
  SUPPORTING
  OTHER
}

enum FieldType {
  FILE
  TEXT
}

enum FieldStatus {
  PENDING
  COMPLETED
}

// Core Models

model User {
  id               Int               @id @default(autoincrement())
  role             Role              @default(STUDENT)
  email            String?           @unique
  password         String?           @db.VarChar(64)
  isActive         Boolean           @default(true)
  emailConfirmed   Boolean           @default(false)
  personalInfo     PersonalInfo?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  applications     Application[]     @relation("UserApplications")
  reviewedApps     Application[]     @relation("Review")
  tickets          Ticket[]
  tasks            Task[]
  messages         Message[]
  groups           Group[]           @relation("GroupStudents")
  supervisedGroups Group[]           @relation("GroupSupervisors")
  userGrants       UserGrant[]
  viewGrants       Grant[]           @relation("GrantViewAccess")
  sentMessages     DirectMessage[]   @relation("SentMessages")
  receivedMessages DirectMessage[]   @relation("ReceivedMessages")
  notifications    Notification[]
}

model PersonalInfo {
  id               Int                @id @default(autoincrement())
  userId           Int                @unique
  user             User               @relation(fields: [userId], references: [id])
  basicInfo        BasicInfo?         @relation(fields: [id], references: [id], map: "BasicInfo_FK")
  contactInfo      ContactInfo?       @relation(fields: [id], references: [id], map: "ContactInfo_FK")
  studyInfo        StudyInformation?  @relation(fields: [id], references: [id], map: "StudyInfo_FK")
}

model BasicInfo {
  id               Int                @id @default(autoincrement())
  name             String
  fatherName       String
  familyName       String
  nationality      String
  residenceCountry String
  passport         String?
  gender           String?
  birthDate        DateTime?
  hasDisability    Boolean?
  disability       String?

  personalInfo     PersonalInfo?
}

model ContactInfo {
  id               Int                @id @default(autoincrement())
  phone            String
  whatsapp         String?
  facebook         String?
  instagram        String?
  twitter          String?

  personalInfo     PersonalInfo?
}

model StudyInformation {
  id               Int                @id @default(autoincrement())
  programType      String
  university       String
  college          String
  department       String
  year             String
  studentIdNo      String

  personalInfo     PersonalInfo?
}

// Application Models

model Application {
  id                Int               @id @default(autoincrement())
  studentId         Int
  supervisorId      Int?
  status            ApplicationStatus @default(PENDING)
  supportingFiles   SupportingFiles?
  rejectReason      String?
  scholarshipInfo   ScholarshipInfo?
  academicPerformance AcademicPerformance?
  residenceInfo     ResidenceInformation?
  siblings          Sibling[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  student           User              @relation("UserApplications", fields: [studentId], references: [id])
  supervisor        User?             @relation("Review", fields: [supervisorId], references: [id])

  updates           File[]
  askedFields       AskedField[]
  improvementRequests ImprovementRequest[]
  userGrants        UserGrant[]
}

model SupportingFiles {
  id               Int                @id @default(autoincrement())
  personalId       File?              @relation(name: "PersonalIdFile", fields: [id], references: [id], map: "PersonalId_FK")
  studentDoc       File?              @relation(name: "StudentDocFile", fields: [id], references: [id], map: "StudentDoc_FK")
  medicalReport    File?              @relation(name: "MedicalReportFile", fields: [id], references: [id], map: "MedicalReport_FK")
  personalPhoto    File?              @relation(name: "PersonalPhotoFile", fields: [id], references: [id], map: "PersonalPhoto_FK")
  proofOfAddress   File?              @relation(name: "ProofOfAddressFile", fields: [id], references: [id], map: "ProofOfAddress_FK")
  applicationId    Int                @unique

  application      Application        @relation(fields: [applicationId], references: [id])
}

model ScholarshipInfo {
  id               Int                @id @default(autoincrement())
  supportType      SupportType
  annualTuitionFee Float?
  providedAmount   Float?
  requestedAmount  Float?
  applicationId    Int                @unique

  application      Application        @relation(fields: [applicationId], references: [id])
}

model ResidenceInformation {
  id               Int                @id @default(autoincrement())
  residenceType    ResidenceType
  fatherStatus     ParentStatus?
  fatherIncome     Float?
  motherStatus     ParentStatus?
  motherIncome     Float?
  familyIncome     Float?
  city             String?
  country          String?
  address          String?
  applicationId    Int                @unique

  application      Application        @relation(fields: [applicationId], references: [id])
}

model AcademicPerformance {
  id               Int                @id @default(autoincrement())
  gpaType          GpaType
  gpaValue         Float?
  transcriptId     Int?               @unique
  transcript       File?              @relation(fields: [transcriptId], references: [id])
  applicationId    Int                @unique

  application      Application        @relation(fields: [applicationId], references: [id])
}

model Sibling {
  id               Int                @id @default(autoincrement())
  userId           Int
  name             String
  relation         String
  education        String
  sourceOfStudy    StudySource
  grantSource      String?
  grantAmount      Float?
  document         File[]
  createdAt        DateTime           @default(now())
  applicationId    Int

  application      Application        @relation(fields: [applicationId], references: [id])
}

// Grants and Payments

model Grant {
  id               Int                @id @default(autoincrement())
  name             String
  type             GrantType
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  userGrants       UserGrant[]
  viewAccessUsers  User[]             @relation("GrantViewAccess")
}

model UserGrant {
  id               Int                @id @default(autoincrement())
  userId           Int
  grantId          Int
  applicationId    Int
  payments         Payment[]
  createdAt        DateTime           @default(now())

  user             User               @relation(fields: [userId], references: [id])
  grant            Grant              @relation(fields: [grantId], references: [id])
  application      Application        @relation(fields: [applicationId], references: [id])
}

model Payment {
  id               Int                @id @default(autoincrement())
  userGrantId      Int
  amount           Float
  dueDate          DateTime
  paidAt           DateTime?
  status           PaymentStatus      @default(PENDING)
  createdAt        DateTime           @default(now())

  userGrant        UserGrant          @relation(fields: [userGrantId], references: [id])
  invoice          Invoice?
}

model Invoice {
  id               Int                @id @default(autoincrement())
  invoiceNumber    String             @unique
  paymentId        Int                @unique
  dueDate          DateTime
  status           PaymentStatus      @default(PENDING)
  amount           Float
  paidAt           DateTime?
  createdAt        DateTime           @default(now())

  payment          Payment            @relation(fields: [paymentId], references: [id])
}

// Admin Requests

model ImprovementRequest {
  id               Int                @id @default(autoincrement())
  fieldId          String
  title            String
  message          String
  status           FieldStatus        @default(PENDING)
  applicationId    Int

  application      Application        @relation(fields: [applicationId], references: [id])
}

model AskedField {
  id               Int                @id @default(autoincrement())
  title            String
  message          String
  type             FieldType
  status           FieldStatus        @default(PENDING)
  value            String?
  applicationId    Int

  application      Application        @relation(fields: [applicationId], references: [id])
}

// Miscellaneous

model Notification {
  id               Int                @id @default(autoincrement())
  content          String
  type             NotificationType
  isRead           Boolean            @default(false)
  userId           Int
  createdAt        DateTime           @default(now())

  user             User               @relation(fields: [userId], references: [id])
}

model Ticket {
  id               Int                @id @default(autoincrement())
  title            String
  content          String
  status           TicketStatus       @default(OPEN)
  createdAt        DateTime           @default(now())

  userId           Int
  user             User               @relation(fields: [userId], references: [id])
  messages         Message[]
}

model Message {
  id               Int                @id @default(autoincrement())
  ticketId         Int
  content          String
  senderId         Int
  createdAt        DateTime           @default(now())

  ticket           Ticket             @relation(fields: [ticketId], references: [id])
  sender           User               @relation(fields: [senderId], references: [id])
}

model DirectMessage {
  id               Int                @id @default(autoincrement())
  content          String
  senderId         Int
  receiverId       Int
  createdAt        DateTime           @default(now())

  sender           User               @relation("SentMessages", fields: [senderId], references: [id])
  receiver         User               @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Group {
  id               Int                @id @default(autoincrement())
  name             String
  createdAt        DateTime           @default(now())
  students         User[]             @relation("GroupStudents")
  supervisors      User[]             @relation("GroupSupervisors")
}

model Task {
  id               Int                @id @default(autoincrement())
  description      String
  status           TaskStatus         @default(PENDING)
  supervisorId     Int
  supervisor       User               @relation(fields: [supervisorId], references: [id])
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model FAQ {
  id               Int                @id @default(autoincrement())
  question         String
  answer           String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model File {
  id               Int                @id @default(autoincrement())
  fileType         FileType           @default(OTHER)
  title            String?
  description      String?
  url              String
  createdAt        DateTime           @default(now())

  personalIdFile    SupportingFiles?  @relation(name: "PersonalIdFile")
  studentDocFile    SupportingFiles?  @relation(name: "StudentDocFile")
  medicalReportFile SupportingFiles?  @relation(name: "MedicalReportFile")
  personalPhotoFile SupportingFiles?  @relation(name: "PersonalPhotoFile")
  proofOfAddressFile SupportingFiles? @relation(name: "ProofOfAddressFile")

  siblingId        Int?
  sibling          Sibling?           @relation(fields: [siblingId], references: [id])

  applicationId    Int?
  application      Application?       @relation(fields: [applicationId], references: [id])

  academicPerformance AcademicPerformance?
}
